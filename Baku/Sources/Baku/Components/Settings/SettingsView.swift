import SwiftUI
import Defaults
import LaunchAtLogin

/// Settings view for Baku preferences
struct SettingsView: View {
    @StateObject private var settings = SettingsManager.shared
    @State private var selectedPlatform: Platform?
    @State private var showingCredentialSheet = false

    var body: some View {
        TabView {
            generalSettings
                .tabItem {
                    Label("General", systemImage: "gearshape")
                }

            platformSettings
                .tabItem {
                    Label("Platforms", systemImage: "app.connected.to.app.below.fill")
                }

            aiSettings
                .tabItem {
                    Label("AI", systemImage: "sparkles")
                }
        }
        .frame(width: 500, height: 400)
        .sheet(isPresented: $showingCredentialSheet) {
            if let platform = selectedPlatform {
                CredentialSheet(platform: platform, settings: settings)
            }
        }
    }

    // MARK: - General Settings

    private var generalSettings: some View {
        Form {
            Section {
                LaunchAtLogin.Toggle("Launch at login")

                DatePicker(
                    "Morning fetch time",
                    selection: Binding(
                        get: { Defaults[.morningTime] },
                        set: { Defaults[.morningTime] = $0 }
                    ),
                    displayedComponents: .hourAndMinute
                )
            }

            Section("Notifications") {
                Toggle("Show badge count", isOn: Binding(
                    get: { Defaults[.morningNotifications] },
                    set: { Defaults[.morningNotifications] = $0 }
                ))
            }

            Section("Behavior") {
                Toggle("Auto-generate response drafts", isOn: Binding(
                    get: { Defaults[.autoGenerateDrafts] },
                    set: { Defaults[.autoGenerateDrafts] = $0 }
                ))
            }
        }
        .formStyle(.grouped)
        .padding()
    }

    // MARK: - Platform Settings

    private var platformSettings: some View {
        Form {
            ForEach(Platform.allCases) { platform in
                Section {
                    HStack {
                        Image(systemName: platform.iconName)
                            .font(.title2)
                            .foregroundColor(platform.accentColor)
                            .frame(width: 30)

                        VStack(alignment: .leading, spacing: 2) {
                            Text(platform.displayName)
                                .font(.headline)
                            Text(platformStatusText(platform))
                                .font(.caption)
                                .foregroundColor(platformStatusColor(platform))
                        }

                        Spacer()

                        if settings.isPlatformConfigured(platform) {
                            Button("Edit") {
                                selectedPlatform = platform
                                showingCredentialSheet = true
                            }
                            .buttonStyle(.bordered)

                            Toggle("", isOn: Binding(
                                get: { settings.isPlatformEnabled(platform) },
                                set: { settings.setPlatformEnabled(platform, enabled: $0) }
                            ))
                            .labelsHidden()
                        } else {
                            Button("Configure") {
                                selectedPlatform = platform
                                showingCredentialSheet = true
                            }
                            .buttonStyle(.borderedProminent)
                        }
                    }
                    .padding(.vertical, 4)
                }
            }
        }
        .formStyle(.grouped)
        .padding()
    }

    private func platformStatusText(_ platform: Platform) -> String {
        if settings.isPlatformConfigured(platform) {
            return settings.isPlatformEnabled(platform) ? "Connected" : "Disabled"
        }
        return "Not configured"
    }

    private func platformStatusColor(_ platform: Platform) -> Color {
        if settings.isPlatformConfigured(platform) {
            return settings.isPlatformEnabled(platform) ? .green : .secondary
        }
        return .secondary
    }

    // MARK: - AI Settings

    private var aiSettings: some View {
        Form {
            Section("Claude API") {
                HStack {
                    Text("API Key")
                    Spacer()
                    if settings.getCredential(platform: .gmail, key: "claude_api_key") != nil {
                        Text("Configured")
                            .foregroundColor(.green)
                        Button("Edit") {
                            // Show API key input
                        }
                        .buttonStyle(.bordered)
                    } else {
                        SecureInputField(
                            placeholder: "sk-ant-...",
                            onSave: { key in
                                settings.setCredential(platform: .gmail, key: "claude_api_key", value: key)
                            }
                        )
                    }
                }

                Text("Get your API key from console.anthropic.com")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }

            Section("Response Style") {
                Picker("Default tone", selection: Binding(
                    get: { Draft.Tone(rawValue: Defaults[.draftTone]) ?? .professional },
                    set: { Defaults[.draftTone] = $0.rawValue }
                )) {
                    ForEach(Draft.Tone.allCases, id: \.self) { tone in
                        Text(tone.displayName).tag(tone)
                    }
                }
            }

            Section("Model") {
                HStack {
                    Text("Model")
                    Spacer()
                    Text("Claude Sonnet 4")
                        .foregroundColor(.secondary)
                }
            }
        }
        .formStyle(.grouped)
        .padding()
    }
}

// MARK: - Credential Sheet

struct CredentialSheet: View {
    let platform: Platform
    @ObservedObject var settings: SettingsManager
    @Environment(\.dismiss) private var dismiss

    @State private var credentials: [String: String] = [:]

    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Image(systemName: platform.iconName)
                    .font(.title)
                    .foregroundColor(platform.accentColor)
                Text("\(platform.displayName) Configuration")
                    .font(.headline)
                Spacer()
            }
            .padding()
            .background(Color(NSColor.windowBackgroundColor))

            Divider()

            // Form
            Form {
                ForEach(credentialFields, id: \.key) { field in
                    if field.isSecret {
                        SecureField(field.label, text: binding(for: field.key))
                    } else {
                        TextField(field.label, text: binding(for: field.key))
                    }
                }

                if let helpText = platform.setupHelpText {
                    Text(helpText)
                        .font(.caption)
                        .foregroundColor(.secondary)
                }

                if let url = platform.setupURL {
                    Link("Get credentials", destination: url)
                        .font(.caption)
                }
            }
            .formStyle(.grouped)
            .padding()

            Divider()

            // Actions
            HStack {
                Button("Remove") {
                    settings.clearAllCredentials(for: platform)
                    settings.setPlatformEnabled(platform, enabled: false)
                    dismiss()
                }
                .foregroundColor(.red)

                Spacer()

                Button("Cancel") {
                    dismiss()
                }
                .keyboardShortcut(.cancelAction)

                Button("Save") {
                    saveCredentials()
                    dismiss()
                }
                .keyboardShortcut(.defaultAction)
                .buttonStyle(.borderedProminent)
            }
            .padding()
        }
        .frame(width: 400, height: 350)
        .onAppear {
            loadCredentials()
        }
    }

    private var credentialFields: [CredentialField] {
        switch platform {
        case .gmail:
            return [
                CredentialField(key: "client_id", label: "Client ID", isSecret: false),
                CredentialField(key: "client_secret", label: "Client Secret", isSecret: true)
            ]
        case .slack:
            return [
                CredentialField(key: "bot_token", label: "Bot Token (xoxb-...)", isSecret: true),
                CredentialField(key: "app_token", label: "App Token (xapp-...)", isSecret: true)
            ]
        case .discord:
            return [
                CredentialField(key: "token", label: "Bot Token", isSecret: true)
            ]
        case .twitter:
            return [
                CredentialField(key: "api_key", label: "API Key", isSecret: false),
                CredentialField(key: "api_secret", label: "API Secret", isSecret: true)
            ]
        case .grok:
            return [
                CredentialField(key: "api_key", label: "API Key", isSecret: true)
            ]
        }
    }

    private func binding(for key: String) -> Binding<String> {
        Binding(
            get: { credentials[key] ?? "" },
            set: { credentials[key] = $0 }
        )
    }

    private func loadCredentials() {
        for field in credentialFields {
            if let value = settings.getCredential(platform: platform, key: field.key) {
                credentials[field.key] = value
            }
        }
    }

    private func saveCredentials() {
        for (key, value) in credentials where !value.isEmpty {
            settings.setCredential(platform: platform, key: key, value: value)
        }
        settings.setPlatformEnabled(platform, enabled: true)
    }
}

struct CredentialField {
    let key: String
    let label: String
    let isSecret: Bool
}

// MARK: - Secure Input Field

struct SecureInputField: View {
    let placeholder: String
    let onSave: (String) -> Void

    @State private var value = ""
    @State private var isEditing = false

    var body: some View {
        HStack {
            if isEditing {
                SecureField(placeholder, text: $value)
                    .textFieldStyle(.roundedBorder)
                    .frame(width: 200)

                Button("Save") {
                    onSave(value)
                    isEditing = false
                    value = ""
                }
                .buttonStyle(.borderedProminent)
            } else {
                Button("Add Key") {
                    isEditing = true
                }
                .buttonStyle(.bordered)
            }
        }
    }
}

// MARK: - Platform Extensions

extension Platform {
    var setupHelpText: String? {
        switch self {
        case .gmail:
            return "Create OAuth credentials in Google Cloud Console"
        case .slack:
            return "Create a Slack app and add Bot Token Scopes"
        case .discord:
            return "Create a Discord application and bot"
        case .twitter:
            return "Apply for Twitter API access (may require approval)"
        case .grok:
            return "Get your xAI API key from the console"
        }
    }

    var setupURL: URL? {
        switch self {
        case .gmail:
            return URL(string: "https://console.cloud.google.com/apis/credentials")
        case .slack:
            return URL(string: "https://api.slack.com/apps")
        case .discord:
            return URL(string: "https://discord.com/developers/applications")
        case .twitter:
            return URL(string: "https://developer.twitter.com/en/portal/dashboard")
        case .grok:
            return URL(string: "https://console.x.ai")
        }
    }
}

#Preview {
    SettingsView()
}
